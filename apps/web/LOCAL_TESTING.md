# Local Testing Guide

## Prerequisites

1. **Install dependencies**
   ```bash
   cd apps/web
   pnpm install
   ```

2. **Install Playwright browsers** (for E2E tests)
   ```bash
   pnpm exec playwright install
   ```

---

## API Endpoints Testing

### Start the dev server
```bash
pnpm dev
```

### Test Health Endpoint
```bash
curl http://localhost:3000/api/health | jq .
```

Expected response:
```json
{
  "status": "healthy",
  "timestamp": "2024-01-01T00:00:00.000Z",
  "version": "0.1.0",
  "environment": "devnet",
  "checks": { "app": "ok", "memory": "ok (115/240MB - 48%)" }
}
```

### Test Verifier Info Endpoint
```bash
curl http://localhost:3000/api/verifier | jq .
```

Expected response:
```json
{
  "publicKey": "EGoXTYgCd5TgpGzTMcVp4ksPGUmL8kqVSini7o63mBJa",
  "circuitsLoaded": { "developer": false, "whale": false },
  "message": "Register this public key in the Anchor program..."
}
```

### Test Verify Endpoint

**Invalid request (validation test):**
```bash
curl -X POST http://localhost:3000/api/verify \
  -H "Content-Type: application/json" \
  -d '{"invalid":"request"}' | jq .
```

Expected: `{"success":false,"error":"Invalid request: Required, Required..."}`

**Valid format (proof will fail - expected):**
```bash
curl -X POST http://localhost:3000/api/verify \
  -H "Content-Type: application/json" \
  -d '{
    "proof": "0123456789abcdef",
    "publicInputs": ["0x01", "0x02"],
    "proofType": "developer",
    "nullifier": "0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef",
    "commitment": "fedcba9876543210fedcba9876543210fedcba9876543210fedcba9876543210"
  }' | jq .
```

Expected: `{"success":false,"error":"Proof verification failed"}`

> **Note:** Proof verification fails because the proof is fake. In production, valid proofs generated by the client will verify successfully.

---

## E2E Tests (Playwright)

### Start the dev server first
```bash
# Terminal 1
pnpm dev
```

### Run all E2E tests
```bash
# Terminal 2
pnpm exec playwright test
```

### Run specific test file
```bash
pnpm exec playwright test e2e/homepage.spec.ts
pnpm exec playwright test e2e/developer.spec.ts
pnpm exec playwright test e2e/whale.spec.ts
pnpm exec playwright test e2e/navigation.spec.ts
pnpm exec playwright test e2e/error-handling.spec.ts
```

### Run tests with UI mode (recommended for debugging)
```bash
pnpm exec playwright test --ui
```

### Run tests in headed mode (see browser)
```bash
pnpm exec playwright test --headed
```

### Run single test by name
```bash
pnpm exec playwright test -g "should display hero section"
```

### Debug a specific test
```bash
pnpm exec playwright test e2e/homepage.spec.ts --debug
```

### View Test Report
```bash
pnpm exec playwright show-report
```

---

## Unit Tests (Vitest)

### Run all unit tests
```bash
pnpm test
```

### Run tests in watch mode
```bash
pnpm test --watch
```

### Run with coverage
```bash
pnpm test:coverage
```

---

## Test Files Overview

| Type | File/Directory | Purpose |
|------|----------------|---------|
| E2E | `e2e/homepage.spec.ts` | Homepage content, navigation, responsive design |
| E2E | `e2e/developer.spec.ts` | Developer proof flow UI states |
| E2E | `e2e/whale.spec.ts` | Whale trading proof flow UI states |
| E2E | `e2e/navigation.spec.ts` | Cross-page navigation, mobile nav, keyboard nav |
| E2E | `e2e/error-handling.spec.ts` | Error boundaries, console errors, 404 handling |
| Unit | `src/lib/__tests__/` | Client SDK unit tests |
| API | `/api/health` | Health check endpoint |
| API | `/api/verifier` | Verifier public key info |
| API | `/api/verify` | ZK proof verification |

---

## Configuration

**Playwright:** `playwright.config.ts`
- Base URL: `http://localhost:3000`
- Browsers: Chromium, Firefox, WebKit
- Timeout: 30 seconds per test

**Vitest:** `vitest.config.ts`
- Environment: jsdom
- Coverage: v8

---

## Troubleshooting

**Tests timing out?**
- Ensure dev server is running on port 3000
- Try increasing timeout in test: `{ timeout: 15000 }`

**Elements not found?**
- React hydration takes time - tests include `waitForTimeout(1000)` for this
- Use `--debug` mode to see what's happening

**SharedArrayBuffer errors in console?**
- Expected for ZK proof functionality - tests filter these out

**API endpoint returns 500?**
- Check server logs in terminal running `pnpm dev`
- Ensure circuit files exist in `public/circuits/`

**Verifier keypair changes on restart?**
- Expected in development (ephemeral keypair)
- Set `VERIFIER_PRIVATE_KEY` env var for persistent keypair
